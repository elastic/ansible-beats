---

- name: Debian - Ensure apt-transport-https is installed
  apt:
    name: apt-transport-https
    state: present
    cache_valid_time: 86400
  when: use_repository | bool
  register: beat_install
  until: beat_install is succeeded
  notify: restart {{ beat }}

- name: Debian - Ensure python-urllib3, python-openssl, python-pyasn1 & python-pip are installed
  apt:
    name:
      - python-urllib3
      - python-openssl
      - python-pyasn1
      - python-pip
    state: present
  register: libs_install
  until: libs_install is succeeded
  when:
    - use_repository | bool
    - ansible_distribution_release == "trusty"

- name: Debian - ensure ndg-httpsclient pip is installed
  pip:
    name: ndg-httpsclient
    state: present
  register: ndg_install
  until: ndg_install is succeeded
  when:
    - use_repository | bool
    - ansible_distribution_release == "trusty"

- name: Debian - Add Beats repository key
  apt_key:
    url: '{{ elastic_gpg_key }}'
    state: present
  register: apt_key_install
  until: apt_key_install is succeeded
  when: use_repository | bool

- name: Debian - add beats repository
  apt_repository:
    repo: 'deb {{ repo_url }} stable main'
    state: present
  register: repo_install
  until: repo_install is succeeded
  when: use_repository | bool

- name: Debian - showhold {{ beat }}
  command: 'apt-mark showhold'
  args:
    warn: false
  register: versionlock_list
  changed_when: false

- name: Debian - unhold {{ beat }} version for install
  command: 'apt-mark unhold {{ beat }}'
  args:
    warn: false
  register: versionlock_del
  when: beat in versionlock_list.stdout
  changed_when: >-
    ('Canceled hold on ' ~ beat) in versionlock_del.stdout
